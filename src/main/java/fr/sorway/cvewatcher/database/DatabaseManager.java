package fr.sorway.cvewatcher.database;

import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;
import fr.sorway.cvewatcher.configuration.Configuration;

import java.sql.Connection;
import java.sql.SQLException;

public class DatabaseManager {
    private final Configuration configuration;
    private HikariDataSource hikariCP;

    public DatabaseManager(Configuration configuration) {
        this.configuration = configuration;
    }

    public void init() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize((Runtime.getRuntime().availableProcessors() * 2) + 1);
        config.setDriverClassName("org.mariadb.jdbc.Driver");
        config.setJdbcUrl(String.format("jdbc:mariadb://%s:%s/%s", configuration.getString("database_host"), configuration.getString("database_port"), configuration.getString("database_database")));
        config.setUsername(configuration.getString("database_username"));
        config.setPassword(configuration.getString("database_password"));
        config.setMaxLifetime(300000);
        config.setConnectionTimeout(120 * 1000);
        config.setLeakDetectionThreshold(60 * 5000);
        this.hikariCP = new HikariDataSource(config);
    }

    public Connection getConnection() throws SQLException {
        if (this.hikariCP == null)
            init();
        return this.hikariCP.getConnection();
    }
}
